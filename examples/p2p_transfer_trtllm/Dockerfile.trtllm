# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# TRT-LLM image with NIXL for P2P weight transfers
# Uses vLLM base image (which has NIXL/UCX working) and adds TRT-LLM
#
# Strategy: Start with vLLM image that has working NIXL, add TRT-LLM runtime

FROM vllm/vllm-openai:v0.12.0 AS base

# Install TRT-LLM dependencies
RUN pip install --quiet tensorrt-llm

# Install NIXL (should work since vLLM base has compatible UCX)
RUN pip install --quiet nixl[cu12]

# Verify NIXL works
RUN python3 -c "import nixl; agent = nixl.nixl_agent('test'); print('NIXL OK')"

# Install Python dependencies for gRPC
RUN pip install --quiet grpcio grpcio-tools protobuf

# Copy ModelExpress proto files
COPY modelexpress_common/proto /opt/modelexpress/proto

# Copy ModelExpress Python client
COPY modelexpress_client/python/modelexpress /opt/modelexpress/client/modelexpress
COPY modelexpress_client/python/pyproject.toml /opt/modelexpress/client/

# Generate Python proto files
WORKDIR /opt/modelexpress/client
RUN python3 -m grpc_tools.protoc \
        -I/opt/modelexpress/proto \
        --python_out=/opt/modelexpress/client/modelexpress \
        --grpc_python_out=/opt/modelexpress/client/modelexpress \
        /opt/modelexpress/proto/p2p.proto && \
    sed -i 's/^import p2p_pb2/from . import p2p_pb2/' /opt/modelexpress/client/modelexpress/p2p_pb2_grpc.py

# Install the ModelExpress client package
RUN pip uninstall -y modelexpress 2>/dev/null || true && \
    rm -rf /usr/local/lib/python3.12/dist-packages/modelexpress* && \
    pip install .

# Clean up build artifacts
RUN rm -rf /tmp/ucx /tmp/nixl

# Back to default workdir
WORKDIR /workspace

# Verify NIXL installation
RUN python3 -c "import nixl; agent = nixl.nixl_agent('test'); print('NIXL OK')"
