# Copyright (c) 2025-2026, NVIDIA CORPORATION. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ModelMetadata CRD for ModelExpress P2P transfers
# This CRD stores NIXL metadata and coordination state as an alternative to Redis
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: modelmetadatas.modelexpress.nvidia.com
  labels:
    app.kubernetes.io/name: modelexpress
    app.kubernetes.io/component: crd
spec:
  group: modelexpress.nvidia.com
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - modelName
              properties:
                modelName:
                  type: string
                  description: Full model name (e.g., deepseek-ai/DeepSeek-V3)
                expectedWorkers:
                  type: integer
                  description: Number of GPU workers expected to publish metadata
                  default: 8
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: Current phase of the model metadata
                  enum:
                    - Pending
                    - Initializing
                    - Ready
                    - Stale
                  default: Pending
                workers:
                  type: array
                  description: Per-worker NIXL metadata and readiness state
                  items:
                    type: object
                    required:
                      - workerRank
                    properties:
                      workerRank:
                        type: integer
                        description: Worker rank (0-indexed)
                      nixlMetadata:
                        type: string
                        format: byte
                        description: Base64-encoded NIXL agent metadata blob
                      tensorCount:
                        type: integer
                        description: Number of tensors registered by this worker
                      tensorConfigMap:
                        type: string
                        description: Name of ConfigMap containing tensor descriptors
                      ready:
                        type: boolean
                        description: Whether worker has completed NIXL registration
                        default: false
                      stabilityVerified:
                        type: boolean
                        description: Whether worker has passed stability verification
                        default: false
                      sessionId:
                        type: string
                        description: Unique session ID for detecting source restarts
                      publishedAt:
                        type: string
                        format: date-time
                        description: Timestamp when worker metadata was published
                conditions:
                  type: array
                  description: Conditions for ModelMetadata lifecycle
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: Condition type
                        enum:
                          - AllWorkersPublished
                          - StabilityVerified
                          - Ready
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      reason:
                        type: string
                        description: Machine-readable reason for condition
                      message:
                        type: string
                        description: Human-readable message
                      lastTransitionTime:
                        type: string
                        format: date-time
                observedGeneration:
                  type: integer
                  format: int64
                  description: Generation observed by the controller
                publishedAt:
                  type: string
                  format: date-time
                  description: Timestamp when first worker published
      additionalPrinterColumns:
        - name: Model
          type: string
          description: Model name
          jsonPath: .spec.modelName
        - name: Phase
          type: string
          description: Current phase
          jsonPath: .status.phase
        - name: Workers
          type: integer
          description: Number of workers ready
          jsonPath: .spec.expectedWorkers
        - name: Ready
          type: string
          description: Ready condition
          jsonPath: .status.conditions[?(@.type=="Ready")].status
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: modelmetadatas
    singular: modelmetadata
    kind: ModelMetadata
    shortNames:
      - mxmeta
      - mm
