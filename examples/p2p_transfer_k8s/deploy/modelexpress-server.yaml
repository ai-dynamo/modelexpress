# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# ModelExpress Server deployment with Kubernetes CRD backend (default)
# For Redis backend, use modelexpress-server-redis.yaml instead
#
# Prerequisites:
#   - Apply CRD: kubectl apply -f crd-modelmetadata.yaml
#   - Apply RBAC: kubectl apply -f rbac-modelmetadata.yaml
apiVersion: v1
kind: Service
metadata:
  name: modelexpress-server
  labels:
    app: modelexpress-server
spec:
  type: ClusterIP
  ports:
    - port: 8001
      targetPort: 8001
      name: grpc
  selector:
    app: modelexpress-server
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: modelexpress-server
  labels:
    app: modelexpress-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: modelexpress-server
  template:
    metadata:
      labels:
        app: modelexpress-server
    spec:
      # ServiceAccount with permissions to manage ModelMetadata CRDs and ConfigMaps
      serviceAccountName: modelexpress
      containers:
        - name: modelexpress-server
          image: nvcr.io/nvidian/dynamo-dev/modelexpress-server:k8s-backend
          imagePullPolicy: Always
          ports:
            - containerPort: 8001
          env:
            # Use Kubernetes CRD backend (no Redis required)
            - name: MX_METADATA_BACKEND
              value: "kubernetes"
            # Namespace for ModelMetadata CRDs (defaults to pod's namespace)
            - name: MX_METADATA_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          resources:
            requests:
              cpu: 4
              memory: 8Gi
          livenessProbe:
            tcpSocket:
              port: 8001
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 8001
            initialDelaySeconds: 10
            periodSeconds: 10
      imagePullSecrets:
        - name: nvcr-imagepullsecret
